# In this example we run Data Parallelism with 2 nodes (4 GPUs each node) using the ViT-H model from Google ViTs. 

# Uncomment the following line if you want experiments to run one after the another
# sequential: true

variables:
  # The number of nodes can be incremented to have a better chance to satisfy the placement 
  nodes: [16]
  dp_model: ['vit_h_16'] # 16 indicate the local batch size, you can change to 32, 64 or 128
  fsdp_model: ['llama3_8b_16']
  hybrid2d_model: ['minerva_7b_16']
  hybrid3d_model: ['llama3_70b_16']
  hybrid3d_moe_model: ['mixtral_8x7b_16']

  # Peers distance: 2.0 = same L1, 4.0 = same group, different L1, 5.0 = different group
  peers_distance: [2.0, 4.0, 5.0]

# In case it is not possible to satisfy placements constraints, this will fail with return code 456
preprocess: |
  echo "--- Searching for desired topology within $SLURM_JOB_NUM_NODES nodes ---"
  echo "Allocated nodes: $SLURM_JOB_NODELIST"

  # Run the tool and capture output
  TOPO_OUTPUT=$(../common/JobPlacer/target/release/job_placer -s leonardo --topology-scontrol <(cat <<EOF
  {
      "constraints": [
          {
              "type": "NodesAtDistance",
              "count": 1,
              "distance": {peers_distance},
              "reference": "First"
          }
      ]
  }
  EOF
  ))
  TOPO_EXIT_CODE=$?

  echo "Tool exit code: $TOPO_EXIT_CODE"
  echo "Tool output: $TOPO_OUTPUT"

  # Check if the command failed
  if [ $TOPO_EXIT_CODE -ne 0 ]; then
      echo "❌ ERROR: Topology search failed with exit code $TOPO_EXIT_CODE."
      exit 456
  fi

  SELECTED_NODES="$TOPO_OUTPUT"

  echo "✅ SUCCESS! Selected Nodes: $SELECTED_NODES"


jobs:
  # The number of nodes can be incremented to have a better chance to satisfy the placement 
  - config: "leonardo__boost_usr_prod__16_nodes"
    config_jobs:

      - tag: "dp_{dp_model}_distance_{peers_distance}"
        variables:
          num_buckets: [50]
        command: "srun -N 2 -w \"$SELECTED_NODES\" ./DLNetBench/cpp/data_parallel/dp {dp_model} {num_buckets} ./DLNetBench"
      - tag: "fsdp_{fsdp_model}_distance_{peers_distance}"
        variables:
          num_units: [16]
          sharding_factor: [4]
        command: "srun -N 2 -w \"$SELECTED_NODES\" ./DLNetBench/cpp/data_parallel/fsdp {fsdp_model} {num_units} {sharding_factor} ./DLNetBench"
      - tag: "hybrid2d_{hybrid2d_model}_distance_{peers_distance}"
        variables: 
          num_stages: [4]
          num_microbatches: [16]
        command: "srun -N 2 -w \"$SELECTED_NODES\" ./DLNetBench/cpp/hybrid_parallel/hybrid_2d {hybrid2d_model} {num_stages} {num_microbatches} ./DLNetBench"
                  #- tag: "hybrid3d_fake_{hybrid3d_model}_distance_{peer_distance}"
                  #variables:
                  #num_shards: [4]
                  #num_stages: [32]
                  #command: "srun -N 32 -w \"$SELECTED_NODES\" ./DLNetBench/cpp/data_parallel/hybrid_3d {hybrid3d_model} {num_stages} {num_microbatches} {num_shards} ./DLNetBench""
          

